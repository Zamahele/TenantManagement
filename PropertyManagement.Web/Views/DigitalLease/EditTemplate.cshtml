@model PropertyManagement.Web.ViewModels.LeaseTemplateViewModel
@{
    ViewData["Title"] = Model.LeaseTemplateId == 0 ? "Create Lease Template" : "Edit Lease Template";
    var isEdit = Model.LeaseTemplateId > 0;
}

<div class="card shadow-lg" style="font-size: 1.15rem;">
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
        <h2 class="mb-0 display-6">
            <i class="bi @(isEdit ? "bi-pencil-square" : "bi-plus-circle")"></i> 
            @ViewData["Title"]
        </h2>
        <a class="btn btn-light text-primary fw-bold" asp-action="Templates">
            <i class="bi bi-arrow-left"></i> Back to Templates
        </a>
    </div>
    <div class="card-body p-4" style="background-color: #f8f9fa;">
        
        <!-- Template Form -->
        <form asp-action="SaveTemplate" method="post" id="templateForm" class="needs-validation" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="LeaseTemplateId" />
            <input type="hidden" asp-for="CreatedAt" />
            <input type="hidden" asp-for="UpdatedAt" />

            <div class="row">
                <!-- Left Column - Template Settings -->
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-gear"></i> Template Settings</h5>
                        </div>
                        <div class="card-body">
                            <!-- Template Name -->
                            <div class="mb-3">
                                <label asp-for="Name" class="form-label fw-semibold required"></label>
                                <input asp-for="Name" class="form-control" placeholder="Enter template name" required />
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                                <label asp-for="Description" class="form-label fw-semibold"></label>
                                <textarea asp-for="Description" class="form-control" rows="3" placeholder="Template description (optional)"></textarea>
                                <span asp-validation-for="Description" class="text-danger small"></span>
                            </div>

                            <!-- Status Toggles -->
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                                    <label asp-for="IsActive" class="form-check-label fw-semibold">
                                        Template is Active
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input asp-for="IsDefault" class="form-check-input" type="checkbox" />
                                    <label asp-for="IsDefault" class="form-check-label fw-semibold">
                                        Set as Default Template
                                    </label>
                                </div>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> Only one template can be the default.
                                </div>
                            </div>

                            <!-- Template Variables -->
                            <div class="mb-3">
                                <label asp-for="TemplateVariables" class="form-label fw-semibold"></label>
                                <textarea asp-for="TemplateVariables" class="form-control font-monospace" rows="4" 
                                         placeholder='{"tenant_name": "{{tenant.fullName}}", "room_number": "{{room.number}}"}'></textarea>
                                <div class="form-text">
                                    <i class="bi bi-code-square"></i> JSON format for template variables (optional)
                                </div>
                                <span asp-validation-for="TemplateVariables" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Insert Variables -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-tag"></i> Quick Insert Variables</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{tenant.fullName}}')">
                                    <i class="bi bi-person"></i> Tenant Name
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{room.number}}')">
                                    <i class="bi bi-door-open"></i> Room Number
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{lease.startDate}}')">
                                    <i class="bi bi-calendar"></i> Start Date
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{lease.endDate}}')">
                                    <i class="bi bi-calendar-check"></i> End Date
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{lease.rentAmount}}')">
                                    <i class="bi bi-currency-dollar"></i> Rent Amount
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertVariable('{{today}}')">
                                    <i class="bi bi-calendar-today"></i> Today's Date
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - HTML Content Editor -->
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-code-slash"></i> HTML Content</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="showPreview()">
                                    <i class="bi bi-eye"></i> Preview
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatHtml()">
                                    <i class="bi bi-text-indent-left"></i> Format
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <textarea asp-for="HtmlContent" class="form-control border-0 font-monospace" 
                                     id="htmlContentEditor" rows="25" required
                                     placeholder="Enter your lease template HTML content here..."></textarea>
                            <span asp-validation-for="HtmlContent" class="text-danger small px-3"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <div>
                            <a asp-action="Templates" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="showPreview()">
                                <i class="bi bi-eye"></i> Preview Template
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi @(isEdit ? "bi-check-circle" : "bi-plus-circle")"></i> 
                                @(isEdit ? "Update" : "Create") Template
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="bi bi-eye me-2"></i>Template Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="border rounded p-3" style="max-height: 70vh; overflow-y: auto; background-color: white;">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
#htmlContentEditor {
    resize: vertical;
    min-height: 400px;
    font-size: 0.9rem;
    line-height: 1.4;
}

.font-monospace {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

.quick-variable-btn {
    transition: all 0.2s ease;
}

.quick-variable-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#previewContent {
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
}

#previewContent h1, #previewContent h2, #previewContent h3 {
    color: #2c3e50;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

#previewContent p {
    margin-bottom: 1rem;
}
</style>

<script>
// Insert variable into HTML content editor
function insertVariable(variable) {
    const editor = document.getElementById('htmlContentEditor');
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const text = editor.value;
    const before = text.substring(0, start);
    const after = text.substring(end, text.length);
    
    editor.value = before + variable + after;
    editor.selectionStart = editor.selectionEnd = start + variable.length;
    editor.focus();
}

// Show preview of template
function showPreview() {
    const htmlContent = document.getElementById('htmlContentEditor').value;
    const previewContent = document.getElementById('previewContent');
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    if (!htmlContent.trim()) {
        previewContent.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i><strong>No Content</strong><br>Please enter some HTML content to preview.</div>';
    } else {
        // Replace template variables with sample data for preview
        let previewHtml = htmlContent
            .replace(/\{\{tenant\.fullName\}\}/g, 'John Smith')
            .replace(/\{\{tenant\.contact\}\}/g, '0821234567')
            .replace(/\{\{room\.number\}\}/g, '101')
            .replace(/\{\{room\.type\}\}/g, 'Single Room')
            .replace(/\{\{lease\.startDate\}\}/g, new Date().toLocaleDateString())
            .replace(/\{\{lease\.endDate\}\}/g, new Date(Date.now() + 365*24*60*60*1000).toLocaleDateString())
            .replace(/\{\{lease\.rentAmount\}\}/g, 'R2,500.00')
            .replace(/\{\{today\}\}/g, new Date().toLocaleDateString());
        
        previewContent.innerHTML = previewHtml;
    }
    
    modal.show();
}

// Basic HTML formatting
function formatHtml() {
    const editor = document.getElementById('htmlContentEditor');
    let content = editor.value;
    
    // Basic formatting - add line breaks after tags
    content = content
        .replace(/></g, '>\n<')
        .replace(/^\s+|\s+$/gm, '') // Trim lines
        .split('\n')
        .filter(line => line.length > 0)
        .join('\n');
    
    editor.value = content;
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const templateForm = document.getElementById('templateForm');
    if (templateForm) {
        templateForm.addEventListener('submit', function(e) {
            const form = this;
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    }

    // Auto-resize textarea
    const htmlEditor = document.getElementById('htmlContentEditor');
    if (htmlEditor) {
        htmlEditor.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.max(400, this.scrollHeight) + 'px';
        });

        // Default template content for new templates
        @if (Model.LeaseTemplateId == 0 && string.IsNullOrEmpty(Model.HtmlContent))
        {
            <text>
            const defaultContent = `<!DOCTYPE html>
<html>
<head>
    <title>Lease Agreement</title>
    <style>
        body { font-family: 'Times New Roman', serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 30px; }
        .section { margin-bottom: 20px; }
        .signature-line { border-bottom: 1px solid #000; width: 200px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>LEASE AGREEMENT</h1>
        <p>Property Management System</p>
    </div>
    
    <div class="section">
        <h3>TENANT INFORMATION</h3>
        <p><strong>Tenant Name:</strong> {{tenant.fullName}}</p>
        <p><strong>Contact Number:</strong> {{tenant.contact}}</p>
    </div>
    
    <div class="section">
        <h3>PROPERTY DETAILS</h3>
        <p><strong>Room Number:</strong> {{room.number}}</p>
        <p><strong>Room Type:</strong> {{room.type}}</p>
    </div>
    
    <div class="section">
        <h3>LEASE TERMS</h3>
        <p><strong>Start Date:</strong> {{lease.startDate}}</p>
        <p><strong>End Date:</strong> {{lease.endDate}}</p>
        <p><strong>Monthly Rent:</strong> {{lease.rentAmount}}</p>
    </div>
    
    <div class="section">
        <h3>TERMS AND CONDITIONS</h3>
        <p>1. The tenant agrees to pay rent on or before the 1st of each month.</p>
        <p>2. No pets are allowed without prior written consent.</p>
        <p>3. The tenant is responsible for keeping the premises clean and in good condition.</p>
        <p>4. 30 days written notice is required for lease termination.</p>
    </div>
    
    <div class="section" style="margin-top: 50px;">
        <table width="100%">
            <tr>
                <td width="50%">
                    <div class="signature-line"></div>
                    <p><strong>Tenant Signature</strong></p>
                    <p>Date: {{today}}</p>
                </td>
                <td width="50%">
                    <div class="signature-line"></div>
                    <p><strong>Landlord Signature</strong></p>
                    <p>Date: {{today}}</p>
                </td>
            </tr>
        </table>
    </div>
</body>
</html>`;
            
            htmlEditor.value = defaultContent;
            </text>
        }
    }
});
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}