@model PropertyManagement.Web.ViewModels.LeaseAgreementViewModel
@{
  var tenants = ViewBag.Tenants as List<PropertyManagement.Web.ViewModels.TenantViewModel>;
  var isEdit = ViewBag.IsEdit as bool? ?? (Model.LeaseAgreementId != 0);
  var currentYear = DateTime.Today.Year;
  var defaultStart = new DateTime(currentYear, 1, 1);
  var defaultEnd = new DateTime(currentYear, 12, 31);
  string startDateValue = Model.StartDate != default ? Model.StartDate.ToString("yyyy-MM-dd") : defaultStart.ToString("yyyy-MM-dd");
  string endDateValue = Model.EndDate != default ? Model.EndDate.ToString("yyyy-MM-dd") : defaultEnd.ToString("yyyy-MM-dd");
  var rentAmountValue = Model.RentAmount != 0 ? Model.RentAmount.ToString("0.##") : "";
  var expectedRentDayValue = Model.ExpectedRentDay != 0 ? Model.ExpectedRentDay : 1;
  var selectedTenant = tenants?.FirstOrDefault(t => t.TenantId == Model.TenantId);
  var selectedRoomId = isEdit ? Model.RoomId : selectedTenant?.RoomId;
  var selectedRoomNumber = isEdit ? Model.Room?.Number : selectedTenant?.Room?.Number;
}
<!-- Lease Agreement Form Content -->
        <!-- Form Error Display -->
        <div id="formErrors" class="alert alert-danger" style="display: none;"></div>
        <div id="formSuccess" class="alert alert-success" style="display: none;"></div>

        <form id="agreementForm" asp-action="CreateOrEdit" method="post" enctype="multipart/form-data" autocomplete="off" class="needs-validation" novalidate>
          @Html.AntiForgeryToken()
          @Html.HiddenFor(m => m.LeaseAgreementId)
          
          <div class="row g-4">
            <!-- Left Column -->
            <div class="col-lg-6">
              <div class="mb-3">
                <label asp-for="TenantId" class="form-label fw-semibold">Tenant <span class="text-danger">*</span></label>
                @if (isEdit)
                {
                  @Html.HiddenFor(m => m.TenantId)
                  <input type="text" class="form-control" value="@selectedTenant?.FullName" readonly />
                  <small class="text-muted">Tenant cannot be changed after lease creation</small>
                }
                else
                {
                  <select asp-for="TenantId" class="form-select" id="TenantId" required onchange="updateRoomFields()">
                    <option value="">-- Select Tenant --</option>
                    @if (tenants != null)
                    {
                      foreach (var tenant in tenants)
                      {
                        <option value="@tenant.TenantId"
                                data-room-id="@tenant.RoomId"
                                data-room-number="@tenant.Room?.Number">
                          @tenant.FullName (Room @tenant.Room?.Number)
                        </option>
                      }
                    }
                  </select>
                  <div class="invalid-feedback">Please select a tenant.</div>
                }
              </div>

              <input type="hidden" asp-for="RoomId" id="RoomId" value="@selectedRoomId" />
              <div class="mb-3">
                <label class="form-label fw-semibold">Room Assignment</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-door-closed"></i>
                  </span>
                  <input type="text" class="form-control" id="RoomDisplay" value="Room @selectedRoomNumber" readonly />
                </div>
                <small class="text-muted">Auto-populated based on tenant selection</small>
              </div>

              <div class="mb-3">
                <label asp-for="RentAmount" class="form-label fw-semibold">Monthly Rent (R) <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">R</span>
                  <input asp-for="RentAmount" 
                         type="number" 
                         class="form-control" 
                         id="RentAmount" 
                         required 
                         min="0" 
                         step="0.01" 
                         value="@rentAmountValue"
                         placeholder="0.00" />
                </div>
                <div class="invalid-feedback">Please enter a valid rent amount.</div>
              </div>

              <div class="mb-3">
                <label asp-for="ExpectedRentDay" class="form-label fw-semibold">Monthly Rent Due Day <span class="text-danger">*</span></label>
                <div class="d-flex align-items-center gap-3">
                  <input asp-for="ExpectedRentDay"
                         type="range"
                         class="form-range flex-grow-1"
                         min="1"
                         max="31"
                         id="ExpectedRentDay"
                         required
                         value="@expectedRentDayValue"
                         oninput="updateRentDayDisplay(this.value)" />
                  <span class="badge bg-primary fs-6 px-3 py-2" id="expectedRentDayValue">@expectedRentDayValue</span>
                </div>
                <small class="text-muted">Day of the month when rent is due</small>
              </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-6">
              <div class="mb-3">
                <label asp-for="StartDate" class="form-label fw-semibold">Lease Start Date <span class="text-danger">*</span></label>
                <input asp-for="StartDate" 
                       type="date" 
                       class="form-control" 
                       id="StartDate" 
                       required 
                       value="@startDateValue" />
                <div class="invalid-feedback">Please select a start date.</div>
              </div>

              <div class="mb-3">
                <label asp-for="EndDate" class="form-label fw-semibold">Lease End Date <span class="text-danger">*</span></label>
                <input asp-for="EndDate" 
                       type="date" 
                       class="form-control" 
                       id="EndDate" 
                       required 
                       value="@endDateValue" />
                <div class="invalid-feedback">Please select an end date.</div>
              </div>

              <div class="mb-3">
                <label for="File" class="form-label fw-semibold">Lease Document (PDF)</label>
                <input asp-for="File" 
                       type="file" 
                       class="form-control" 
                       accept=".pdf"
                       id="fileInput" />
                <div class="form-text">Upload a PDF document (optional)</div>
                
                @if (isEdit && !string.IsNullOrEmpty(Model.FilePath))
                {
                  <div class="mt-2">
                    <div class="d-flex align-items-center gap-2">
                      <i class="bi bi-file-earmark-pdf text-danger"></i>
                      <a href="@Model.FilePath" target="_blank" class="text-decoration-none">
                        Current Document
                      </a>
                    </div>
                  </div>
                }
              </div>

              <div class="mb-3">
                <div class="card border-info bg-light">
                  <div class="card-body p-3">
                    <h6 class="card-title text-info mb-2">
                      <i class="bi bi-info-circle"></i> Lease Summary
                    </h6>
                    <div id="leaseSummary">
                      <p class="mb-1"><strong>Duration:</strong> <span id="leaseDuration">--</span></p>
                      <p class="mb-1"><strong>Total Value:</strong> <span id="leaseValue">--</span></p>
                      <p class="mb-0"><strong>Next Payment:</strong> <span id="nextPayment">--</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>

      <div class="row mt-4">
        <div class="col-12">
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="closeLeaseModal()">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="saveAgreementBtn">
              <i class="bi bi-save"></i>
              <span class="submit-text">@(isEdit ? "Update Agreement" : "Save Agreement")</span>
              <div class="spinner-border spinner-border-sm ms-2" style="display: none;" role="status" aria-hidden="true"></div>
            </button>
          </div>
        </div>
      </div>
<script type="text/javascript">
  // All JavaScript functions are now in the master view (Index.cshtml)
  // This ensures they are globally available when the form is loaded dynamically
  
  // Auto-initialize when this partial loads
  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('agreementForm') && typeof initializeLeaseForm === 'function') {
      initializeLeaseForm();
    }
  });
  
  // Initialize immediately for dynamic content
  setTimeout(function() {
    if (document.getElementById('agreementForm') && typeof initializeLeaseForm === 'function') {
      initializeLeaseForm();
    }
  }, 100);
</script>