@model RoomsTabViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@using PropertyManagement.Domain.Entities
@using PropertyManagement.Web.ViewModels
@{
  ViewData["Title"] = "Rooms";
}

<!-- Page Header -->
<div class="page-header mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <div class="page-title">
      <h1 class="page-title-main">
        <div class="page-icon">
          <i class="bi bi-door-closed"></i>
        </div>
        Rooms Dashboard
      </h1>
      <p class="page-title-sub text-secondary mb-0">Manage room availability, maintenance status, and booking requests</p>
    </div>
    <div class="page-actions">
      <div class="d-flex align-items-center gap-3">
        <div class="page-info text-center">
          <div class="text-secondary small">Total Rooms</div>
          <div class="fw-semibold">@Model.AllRooms.Count()</div>
        </div>
        <div class="page-info text-center">
          <div class="text-secondary small">Occupied</div>
          <div class="fw-semibold text-info">@Model.OccupiedRooms.Count()</div>
        </div>
        <div class="page-info text-center">
          <div class="text-secondary small">Available</div>
          <div class="fw-semibold text-success">@Model.VacantRooms.Count()</div>
        </div>
        <button class="btn btn-primary page-action-btn primary" onclick="openAddModal()">
          <i class="bi bi-plus-circle"></i>
          Add Room
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Room Management Container -->
<div class="content-section">
  <div class="card-elevated">
    <!-- Professional Tab Navigation -->
    <div class="nav-tabs-container">
      <ul class="nav nav-tabs nav-tabs-professional" id="roomTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
            <i class="bi bi-grid-3x3-gap me-2"></i>
            All Rooms
            <span class="nav-badge">@Model.AllRooms.Count()</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="occupied-tab" data-bs-toggle="tab" data-bs-target="#occupied" type="button" role="tab">
            <i class="bi bi-house-lock me-2"></i>
            Occupied
            <span class="nav-badge bg-info">@Model.OccupiedRooms.Count()</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="vacant-tab" data-bs-toggle="tab" data-bs-target="#vacant" type="button" role="tab">
            <i class="bi bi-house-check me-2"></i>
            Available
            <span class="nav-badge bg-success">@Model.VacantRooms.Count()</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab">
            <i class="bi bi-wrench-adjustable me-2"></i>
            Maintenance
            <span class="nav-badge bg-warning">@Model.MaintenanceRooms.Count()</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests" type="button" role="tab">
            <i class="bi bi-bell me-2"></i>
            Requests
            @if (Model.PendingRequestCount > 0)
            {
              <span class="nav-badge bg-danger">
                @Model.PendingRequestCount
              </span>
            }
            else
            {
              <span class="nav-badge">0</span>
            }
          </button>
        </li>
      </ul>
    </div>
    <div class="tab-content" id="roomTabsContent">
      <div class="tab-pane fade show active" id="all" role="tabpanel">
        @{ ViewData["TabId"] = "all"; }
        @Html.Partial("_RoomTable", Model.AllRooms, ViewData)
      </div>
      <div class="tab-pane fade" id="occupied" role="tabpanel">
        @{ ViewData["TabId"] = "occupied"; }
        @Html.Partial("_RoomTable", Model.OccupiedRooms, ViewData)
      </div>
      <div class="tab-pane fade" id="vacant" role="tabpanel">
        @{ ViewData["TabId"] = "vacant"; }
        @Html.Partial("_RoomTable", Model.VacantRooms, ViewData)
      </div>
      <div class="tab-pane fade" id="maintenance" role="tabpanel">
        @{ ViewData["TabId"] = "maintenance"; }
        @Html.Partial("_RoomTable", Model.MaintenanceRooms, ViewData)
      </div>
      <div class="tab-pane fade" id="requests" role="tabpanel">
        @Html.Partial("_BookingRequestsTable", Model.PendingBookingRequests)
      </div>
    </div>
  </div>
</div>

@Html.Partial("_RoomModal", new RoomFormViewModel { StatusOptions = Model.StatusOptions.Where(s => s.Value == "Available"), RoomTypes = Model.RoomTypes })
<div id="bookingModalContainer"></div>

@section Scripts {
  <script>
    // Get CSRF token for AJAX requests
    function getAntiForgeryToken() {
        return $('input[name="__RequestVerificationToken"]').val();
    }
    
    function openAddModal() {
        document.getElementById('roomForm').reset();
        document.getElementById('RoomId').value = 0;
        document.getElementById('roomModalLabel').innerText = 'Add Room';
        var modal = new bootstrap.Modal(document.getElementById('roomModal'));
        modal.show();
    }

    function openEditModal(id) {
        fetch('/Rooms/GetRoom/' + id)
            .then(response => response.json())
            .then(data => {
                document.getElementById('roomForm').reset();
                if (document.getElementById('RoomId')) document.getElementById('RoomId').value = data.roomId;
                if (document.getElementById('Number')) document.getElementById('Number').value = data.number;
                if (document.getElementById('Type')) document.getElementById('Type').value = data.type;
                if (document.getElementById('Status')) document.getElementById('Status').value = data.status;
                if (document.getElementById('CottageId')) document.getElementById('CottageId').value = data.cottageId || '';
                document.getElementById('roomModalLabel').innerText = 'Edit Room';
                var modal = new bootstrap.Modal(document.getElementById('roomModal'));
                modal.show();
            });
    }
    function deleteRoom(id) {
        if (confirm('Are you sure you want to delete this room? This action cannot be undone.')) {
            document.getElementById('deleteForm-' + id).submit();
        }
    }
    function BookRoom(roomId) {
        fetch('/Rooms/BookRoom?roomId=' + roomId, {
            method: 'GET',
            headers: {
                'RequestVerificationToken': getAntiForgeryToken()
            }
        })
            .then(response => response.text())
            .then(html => {
                document.getElementById('bookingModalContainer').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();
            });
    }

    function editBookingRequest(bookingRequestId) {
        fetch('/Rooms/EditBookingRequest?bookingRequestId=' + bookingRequestId, {
            method: 'GET',
            headers: {
                'RequestVerificationToken': getAntiForgeryToken()
            }
        })
            .then(response => response.text())
            .then(html => {
                document.getElementById('bookingModalContainer').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();
            });
    }
    // Save the active tab to localStorage when changed
    document.addEventListener('DOMContentLoaded', function () {
        var tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabEls.forEach(function (tabEl) {
            tabEl.addEventListener('shown.bs.tab', function (event) {
                localStorage.setItem('activeRoomTab', event.target.id);
                
                // After tab is shown, recalculate DataTable columns
                setTimeout(function() {
                    var targetTab = document.querySelector(event.target.getAttribute('data-bs-target'));
                    if (targetTab) {
                        var tables = targetTab.querySelectorAll('table[data-datatable]');
                        tables.forEach(function(table) {
                            if ($.fn.DataTable.isDataTable('#' + table.id)) {
                                $('#' + table.id).DataTable().columns.adjust().responsive.recalc();
                            }
                        });
                    }
                }, 10);
            });
        });

        // On page load, restore the active tab
        var activeTab = localStorage.getItem('activeRoomTab');
        if (activeTab) {
            var triggerEl = document.getElementById(activeTab);
            if (triggerEl) {
                var tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }
        }
        
    });

  </script>
}